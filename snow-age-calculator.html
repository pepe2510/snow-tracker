<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>é›ªé½¡è¨ˆç®—å™¨</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@300;400;700&family=Bebas+Neue&display=swap" rel="stylesheet">

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
  import {
    getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
  import {
    getFirestore, collection, onSnapshot,
    addDoc, deleteDoc, doc, query, orderBy, serverTimestamp, writeBatch, getDocs
  } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey:            "AIzaSyBFWZcPwH8D5rr5UJcUMOTQEZ6mzptkkFY",
    authDomain:        "snow-age-calculator.firebaseapp.com",
    projectId:         "snow-age-calculator",
    storageBucket:     "snow-age-calculator.firebasestorage.app",
    messagingSenderId: "527060791092",
    appId:             "1:527060791092:web:0e96e161c944016030ff61"
  };

  const app  = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);
  const COL  = 'ski-entries';

  let unsubscribe = null;

  // â”€â”€ Auth state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  onAuthStateChanged(auth, user => {
    if (user) {
      // ç™»å…¥æˆåŠŸ
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('mainApp').style.display = 'block';
      document.getElementById('userEmail').textContent = user.email;
      document.getElementById('userAvatar').src = user.photoURL || '';
      document.getElementById('userAvatar').style.display = user.photoURL ? 'block' : 'none';
      startListening(user.uid);
    } else {
      // æœªç™»å…¥
      document.getElementById('loginScreen').style.display = 'flex';
      document.getElementById('mainApp').style.display = 'none';
      if (unsubscribe) { unsubscribe(); unsubscribe = null; }
      window.entries = [];
      hideLoading();
    }
  });

  // â”€â”€ Firestore listener (per user) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function startListening(uid) {
    if (unsubscribe) unsubscribe();
    const q = query(
      collection(db, 'users', uid, COL),
      orderBy('createdAt', 'asc')
    );
    unsubscribe = onSnapshot(q,
      snap => {
        window.entries = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        render();
        setSyncStatus('synced', 'å·²åŒæ­¥ Â· Firebase å³æ™‚åŒæ­¥');
        hideLoading();
      },
      err => {
        setSyncStatus('error', 'é€£ç·šå¤±æ•—ï¼š' + err.message);
        hideLoading();
      }
    );
  }

  // â”€â”€ Expose Firebase actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  window._fbSignIn = async () => {
    try {
      await signInWithPopup(auth, new GoogleAuthProvider());
    } catch(e) {
      showToast('âš  ç™»å…¥å¤±æ•—ï¼š' + e.message);
    }
  };

  window._fbSignOut = async () => {
    if (!confirm('ç¢ºå®šè¦ç™»å‡ºï¼Ÿ')) return;
    await signOut(auth);
  };

  window._fbAdd = async (entry) => {
    const uid = auth.currentUser?.uid;
    if (!uid) throw new Error('æœªç™»å…¥');
    const { id, ...data } = entry;
    await addDoc(collection(db, 'users', uid, COL), { ...data, createdAt: serverTimestamp() });
  };

  window._fbDelete = async (id) => {
    const uid = auth.currentUser?.uid;
    if (!uid) throw new Error('æœªç™»å…¥');
    await deleteDoc(doc(db, 'users', uid, COL, id));
  };

  window._fbClearAll = async () => {
    const uid = auth.currentUser?.uid;
    if (!uid) throw new Error('æœªç™»å…¥');
    const snap = await getDocs(collection(db, 'users', uid, COL));
    const batch = writeBatch(db);
    snap.forEach(d => batch.delete(d.ref));
    await batch.commit();
  };
</script>

<style>
  :root {
    --bg: #0a0e1a;
    --surface: #111827;
    --card: #1a2235;
    --border: #2a3a55;
    --accent: #7dd3fc;
    --accent2: #38bdf8;
    --snow: #e0f2fe;
    --text: #cbd5e1;
    --muted: #64748b;
    --danger: #f87171;
    --success: #4ade80;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    background: var(--bg); color: var(--text);
    font-family: 'Noto Serif TC', serif;
    min-height: 100vh; overflow-x: hidden;
  }

  /* Snow */
  .snow-bg { position: fixed; inset: 0; pointer-events: none; z-index: 0; overflow: hidden; }
  .flake {
    position: absolute; top: -20px;
    color: rgba(224,242,254,0.3); font-size: 1rem;
    animation: fall linear infinite; user-select: none;
  }
  @keyframes fall { to { transform: translateY(110vh) rotate(360deg); } }

  /* Loading */
  .loading-overlay {
    position: fixed; inset: 0; z-index: 999; background: var(--bg);
    display: flex; flex-direction: column;
    align-items: center; justify-content: center; gap: 16px; transition: opacity 0.5s;
  }
  .loading-overlay.hidden { opacity: 0; pointer-events: none; }
  .loading-logo { font-family: 'Bebas Neue', sans-serif; font-size: 3rem; color: var(--snow); letter-spacing: 0.1em; }
  .loading-spinner {
    width: 32px; height: 32px;
    border: 3px solid var(--border); border-top-color: var(--accent2);
    border-radius: 50%; animation: spin 0.8s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  .loading-text { font-size: 0.85rem; color: var(--muted); letter-spacing: 0.1em; }

  /* Toast */
  .toast {
    position: fixed; bottom: 28px; left: 50%;
    transform: translateX(-50%) translateY(80px);
    background: #1e3a5f; border: 1px solid var(--accent);
    border-radius: 10px; padding: 10px 22px;
    font-size: 0.85rem; color: var(--snow);
    transition: transform 0.3s ease; z-index: 200; white-space: nowrap;
  }
  .toast.show { transform: translateX(-50%) translateY(0); }

  /* â”€â”€ Login screen â”€â”€ */
  #loginScreen {
    display: none;
    position: fixed; inset: 0; z-index: 10;
    flex-direction: column; align-items: center; justify-content: center; gap: 32px;
    background: var(--bg);
  }
  .login-logo {
    font-family: 'Bebas Neue', sans-serif;
    font-size: clamp(3.5rem, 12vw, 7rem);
    color: var(--snow); letter-spacing: 0.08em; line-height: 1;
    text-shadow: 0 0 60px rgba(125,211,252,0.5), 0 0 120px rgba(56,189,248,0.2);
  }
  .login-subtitle { color: var(--muted); font-size: 0.9rem; letter-spacing: 0.15em; margin-top: -20px; }
  .login-card {
    background: var(--card); border: 1px solid var(--border);
    border-radius: 20px; padding: 36px 40px;
    text-align: center; max-width: 360px; width: 90%;
  }
  .login-card h2 { font-size: 1rem; color: var(--snow); margin-bottom: 8px; }
  .login-card p { font-size: 0.82rem; color: var(--muted); margin-bottom: 24px; line-height: 1.6; }
  .btn-google {
    display: flex; align-items: center; justify-content: center; gap: 12px;
    width: 100%; padding: 13px 20px;
    background: #fff; border: none; border-radius: 10px;
    font-family: 'Noto Serif TC', serif; font-size: 0.95rem; color: #1f2937;
    cursor: pointer; font-weight: 700;
    transition: opacity 0.2s, transform 0.1s;
    box-shadow: 0 2px 12px rgba(0,0,0,0.3);
  }
  .btn-google:hover { opacity: 0.92; }
  .btn-google:active { transform: scale(0.98); }
  .btn-google svg { flex-shrink: 0; }

  /* â”€â”€ Main app â”€â”€ */
  #mainApp { display: none; }
  .container { position: relative; z-index: 1; max-width: 780px; margin: 0 auto; padding: 40px 20px 80px; }
  header { text-align: center; margin-bottom: 40px; }
  .logo {
    font-family: 'Bebas Neue', sans-serif;
    font-size: clamp(3rem, 10vw, 6rem);
    letter-spacing: 0.08em; color: var(--snow); line-height: 1;
    text-shadow: 0 0 60px rgba(125,211,252,0.4), 0 0 120px rgba(56,189,248,0.2);
  }
  .subtitle { margin-top: 8px; color: var(--muted); font-size: 0.9rem; letter-spacing: 0.15em; }

  /* User bar */
  .user-bar {
    display: flex; align-items: center; justify-content: center;
    gap: 10px; margin-bottom: 10px; font-size: 0.8rem; color: var(--muted);
  }
  .user-avatar {
    width: 24px; height: 24px; border-radius: 50%;
    border: 1px solid var(--border); object-fit: cover;
  }
  .btn-signout {
    background: none; border: 1px solid var(--border); border-radius: 6px;
    color: var(--muted); font-size: 0.72rem; padding: 2px 10px;
    cursor: pointer; font-family: 'Noto Serif TC', serif;
    transition: border-color 0.2s, color 0.2s;
  }
  .btn-signout:hover { border-color: var(--danger); color: var(--danger); }

  /* Sync bar */
  .sync-bar {
    display: flex; align-items: center; justify-content: center;
    gap: 8px; margin-bottom: 24px; font-size: 0.78rem; color: var(--muted); letter-spacing: 0.08em;
  }
  .sync-dot {
    width: 8px; height: 8px; border-radius: 50%;
    background: var(--muted); transition: background 0.4s;
  }
  .sync-dot.synced  { background: var(--success); box-shadow: 0 0 8px rgba(74,222,128,0.6); }
  .sync-dot.syncing { background: var(--accent2); animation: pulse 1s infinite; }
  .sync-dot.error   { background: var(--danger); }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.3} }

  /* Total banner */
  .total-banner {
    background: linear-gradient(135deg, #0c4a6e, #1e3a5f);
    border: 1px solid var(--accent); border-radius: 16px;
    padding: 24px 32px; margin-bottom: 32px;
    display: flex; align-items: center; justify-content: space-between;
    gap: 16px; box-shadow: 0 0 40px rgba(56,189,248,0.1);
  }
  .total-label { font-size: 1rem; color: var(--accent); letter-spacing: 0.1em; }
  .total-days {
    font-family: 'Bebas Neue', sans-serif; font-size: 3.5rem;
    color: var(--snow); line-height: 1; text-shadow: 0 0 30px rgba(125,211,252,0.6);
  }
  .total-unit { font-size: 1rem; color: var(--muted); margin-top: 4px; }
  .total-right { text-align: right; }
  .ski-age-badge {
    background: rgba(56,189,248,0.1); border: 1px solid rgba(56,189,248,0.3);
    border-radius: 10px; padding: 8px 16px; font-size: 0.85rem; color: var(--accent); text-align: center;
  }

  /* Form */
  .form-card {
    background: var(--card); border: 1px solid var(--border);
    border-radius: 16px; padding: 28px; margin-bottom: 24px;
  }
  .form-title { font-size: 0.8rem; letter-spacing: 0.2em; color: var(--muted); margin-bottom: 20px; text-transform: uppercase; }
  .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
  .field { display: flex; flex-direction: column; gap: 6px; }
  .field.full { grid-column: 1 / -1; }
  label { font-size: 0.78rem; color: var(--muted); letter-spacing: 0.12em; }
  input {
    background: var(--surface); border: 1px solid var(--border); border-radius: 8px;
    color: var(--text); padding: 10px 14px;
    font-family: 'Noto Serif TC', serif; font-size: 0.9rem;
    transition: border-color 0.2s, box-shadow 0.2s; outline: none; width: 100%;
  }
  input:focus { border-color: var(--accent2); box-shadow: 0 0 0 3px rgba(56,189,248,0.12); }
  .btn-add {
    width: 100%; margin-top: 16px;
    background: linear-gradient(135deg, #0369a1, #0284c7);
    border: none; border-radius: 10px; color: #fff;
    font-family: 'Noto Serif TC', serif; font-size: 1rem;
    padding: 12px; cursor: pointer; letter-spacing: 0.1em;
    transition: opacity 0.2s, transform 0.1s;
  }
  .btn-add:hover { opacity: 0.9; }
  .btn-add:active { transform: scale(0.98); }
  .btn-add:disabled { opacity: 0.5; cursor: not-allowed; }

  /* Entries */
  .entries-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
  .entries-label { font-size: 0.8rem; letter-spacing: 0.2em; color: var(--muted); text-transform: uppercase; }
  .entries-controls { display: flex; gap: 8px; align-items: center; }
  .btn-sort {
    background: none; border: 1px solid var(--border); border-radius: 6px;
    color: var(--accent); font-size: 0.75rem; padding: 4px 12px; cursor: pointer;
    font-family: 'Noto Serif TC', serif; transition: background 0.2s, border-color 0.2s;
    display: flex; align-items: center; gap: 5px; white-space: nowrap;
  }
  .btn-sort:hover { background: rgba(125,211,252,0.08); border-color: var(--accent); }
  .sort-arrow { font-size: 0.85rem; transition: transform 0.3s; display: inline-block; }
  .sort-arrow.asc { transform: rotate(180deg); }
  .btn-clear {
    background: none; border: 1px solid rgba(248,113,113,0.3); border-radius: 6px;
    color: var(--danger); font-size: 0.75rem; padding: 4px 12px; cursor: pointer;
    font-family: 'Noto Serif TC', serif; transition: background 0.2s;
  }
  .btn-clear:hover { background: rgba(248,113,113,0.1); }
  .entries-list { display: flex; flex-direction: column; gap: 10px; }
  .entry-card {
    background: var(--card); border: 1px solid var(--border);
    border-radius: 12px; padding: 16px 20px;
    display: flex; align-items: center; gap: 16px; animation: slideIn 0.3s ease;
  }
  @keyframes slideIn { from { opacity:0; transform:translateY(-8px); } to { opacity:1; transform:translateY(0); } }
  .entry-num { font-family: 'Bebas Neue', sans-serif; font-size: 1.8rem; color: var(--accent); min-width: 36px; text-align: center; line-height: 1; }
  .entry-info { flex: 1; }
  .entry-resort { font-size: 1rem; color: var(--snow); margin-bottom: 3px; }
  .entry-meta { font-size: 0.78rem; color: var(--muted); display: flex; gap: 10px; flex-wrap: wrap; }
  .entry-days { font-family: 'Bebas Neue', sans-serif; font-size: 2rem; color: var(--accent2); line-height: 1; text-align: right; white-space: nowrap; }
  .entry-days-label { font-size: 0.72rem; color: var(--muted); text-align: right; }
  .btn-delete {
    background: none; border: none; color: var(--muted); cursor: pointer;
    font-size: 1.1rem; padding: 4px; border-radius: 6px; line-height: 1;
    transition: color 0.2s, background 0.2s;
  }
  .btn-delete:hover { color: var(--danger); background: rgba(248,113,113,0.1); }
  .empty-state {
    text-align: center; padding: 40px; color: var(--muted); font-size: 0.9rem;
    letter-spacing: 0.05em; border: 1px dashed var(--border); border-radius: 12px;
  }
  .empty-icon { font-size: 2.5rem; margin-bottom: 12px; }

  @media (max-width: 480px) {
    .form-grid { grid-template-columns: 1fr; }
    .field.full { grid-column: 1; }
    .total-banner { flex-direction: column; align-items: flex-start; }
    .login-card { padding: 28px 24px; }
  }
</style>
</head>
<body>

<!-- Loading -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="loading-logo">â„ é›ªé½¡</div>
  <div class="loading-spinner"></div>
  <div class="loading-text">é€£æ¥ä¸­â€¦</div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<!-- Snow -->
<div class="snow-bg" id="snowBg"></div>

<!-- â”€â”€ Login screen â”€â”€ -->
<div id="loginScreen">
  <div class="login-logo">é›ª é½¡</div>
  <div class="login-subtitle">SKI DAYS TRACKER</div>
  <div class="login-card">
    <h2>ç™»å…¥ä»¥ç¹¼çºŒ</h2>
    <p>ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥<br>ä½ çš„ç´€éŒ„å°‡å®‰å…¨åœ°å„²å­˜åœ¨é›²ç«¯</p>
    <button class="btn-google" onclick="window._fbSignIn()">
      <svg width="20" height="20" viewBox="0 0 48 48">
        <path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/>
        <path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/>
        <path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/>
        <path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.18 1.48-4.97 2.31-8.16 2.31-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/>
      </svg>
      ä½¿ç”¨ Google ç™»å…¥
    </button>
  </div>
</div>

<!-- â”€â”€ Main app â”€â”€ -->
<div id="mainApp">
  <div class="container">
    <header>
      <div class="logo">é›ª é½¡</div>
      <div class="subtitle">SKI DAYS TRACKER Â· ç´¯ç©ä½ çš„é›ªä¸Šæ­²æœˆ</div>
    </header>

    <div class="user-bar">
      <img class="user-avatar" id="userAvatar" src="" alt="">
      <span id="userEmail"></span>
      <button class="btn-signout" onclick="window._fbSignOut()">ç™»å‡º</button>
    </div>

    <div class="sync-bar">
      <div class="sync-dot syncing" id="syncDot"></div>
      <span id="syncLabel">é€£æ¥ä¸­â€¦</span>
    </div>

    <div class="total-banner">
      <div>
        <div class="total-label">â›· ç´¯ç©é›ªé½¡</div>
        <div class="total-days" id="totalDays">0</div>
        <div class="total-unit">å¤©</div>
      </div>
      <div class="total-right">
        <div class="ski-age-badge" id="skiAgeBadge">å°šç„¡ç´€éŒ„</div>
      </div>
    </div>

    <div class="form-card">
      <div class="form-title">ï¼‹ æ–°å¢æ»‘é›ªç´€éŒ„</div>
      <div class="form-grid">
        <div class="field">
          <label>é–‹å§‹æ—¥æœŸï¼ˆé¸å¡«ï¼‰</label>
          <input type="date" id="inputDateStart" onchange="onDateChange()">
        </div>
        <div class="field">
          <label>çµæŸæ—¥æœŸï¼ˆé¸å¡«ï¼‰</label>
          <input type="date" id="inputDateEnd" onchange="onDateChange()">
        </div>
        <div class="field full">
          <label>é›ªå ´ *</label>
          <input type="text" id="inputResort" placeholder="ä¾‹ï¼šåŒ—æµ·é“äºŒä¸–è°·ã€å¥§åœ°åˆ© Ischglâ€¦">
        </div>
        <div class="field">
          <label>å¤©æ•¸ *</label>
          <input type="number" id="inputDays" placeholder="0" min="1" max="365">
        </div>
        <div class="field">
          <label>å‚™è¨»ï¼ˆé¸å¡«ï¼‰</label>
          <input type="text" id="inputNote" placeholder="ä¾‹ï¼šç²‰é›ªå­£ã€åˆå­¸">
        </div>
      </div>
      <button class="btn-add" id="btnAdd" onclick="addEntry()">åŠ å…¥ç´€éŒ„</button>
    </div>

    <div class="entries-header">
      <div class="entries-label">æ­·å¹´ç´€éŒ„</div>
      <div class="entries-controls">
        <button class="btn-sort" onclick="toggleSort()">
          <span class="sort-arrow" id="sortArrow">â†“</span>
          <span id="sortLabel">æ–°åˆ°èˆŠ</span>
        </button>
        <button class="btn-clear" onclick="clearAll()">æ¸…é™¤å…¨éƒ¨</button>
      </div>
    </div>
    <div class="entries-list" id="entriesList"></div>
  </div>
</div>

<script>
// â”€â”€ Snow â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const snowBg = document.getElementById('snowBg');
for (let i = 0; i < 42; i++) {
  const f = document.createElement('div');
  f.className = 'flake';
  f.textContent = ['â„','â…','â†','âœ¦','Â·','*'][Math.floor(Math.random()*6)];
  f.style.left = Math.random() * 100 + 'vw';
  f.style.fontSize = (0.6 + Math.random() * 1.2) + 'rem';
  f.style.animationDuration = (6 + Math.random() * 14) + 's';
  f.style.animationDelay = '-' + (Math.random() * 15) + 's';
  f.style.opacity = 0.15 + Math.random() * 0.4;
  snowBg.appendChild(f);
}

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.entries = [];
let sortOrder = 'desc';

// â”€â”€ UI helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function hideLoading() {
  const el = document.getElementById('loadingOverlay');
  if (!el) return;
  el.classList.add('hidden');
  setTimeout(() => el.remove(), 600);
}

function setSyncStatus(state, label) {
  const dot = document.getElementById('syncDot');
  const lbl = document.getElementById('syncLabel');
  if (dot) dot.className = 'sync-dot ' + state;
  if (lbl) lbl.textContent = label;
}

function showToast(msg, duration = 2400) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), duration);
}

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getSkiAgeLabel(days) {
  if (days === 0)  return 'å°šç„¡ç´€éŒ„';
  if (days < 10)  return 'ğŸ£ åˆå­¸è€…';
  if (days < 30)  return 'ğŸ¿ å…¥é–€æ»‘æ‰‹';
  if (days < 60)  return 'â›· ç†Ÿç·´æ»‘æ‰‹';
  if (days < 100) return 'ğŸ” é€²éšå¥½æ‰‹';
  if (days < 200) return 'ğŸ¥‡ è³‡æ·±é›ªå®¢';
  return 'ğŸ¦… é›ªå ´å‚³èªª';
}

function formatDateRange(e) {
  if (e.dateStart && e.dateEnd) return e.dateStart + ' ï½ ' + e.dateEnd;
  if (e.dateStart)              return e.dateStart + ' èµ·';
  if (e.dateEnd)                return e.dateEnd + ' æ­¢';
  if (e.date)                   return e.date;
  return e.year ? e.year + ' å¹´' : 'â€”';
}

function escHtml(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function render() {
  const total = window.entries.reduce((s, e) => s + (e.days || 0), 0);
  document.getElementById('totalDays').textContent = total;
  document.getElementById('skiAgeBadge').textContent = getSkiAgeLabel(total);

  const list = document.getElementById('entriesList');
  if (window.entries.length === 0) {
    list.innerHTML = `<div class="empty-state"><div class="empty-icon">ğŸ”</div>é‚„æ²’æœ‰ä»»ä½•ç´€éŒ„<br>å¡«å¯«ä¸Šæ–¹è¡¨å–®ï¼Œé–‹å§‹ç´¯ç©ä½ çš„é›ªé½¡å§ï¼</div>`;
    return;
  }

  const sorted = [...window.entries].sort((a, b) => {
    const dir = sortOrder === 'desc' ? -1 : 1;
    const aKey = a.dateStart || a.date || String(a.year || 0);
    const bKey = b.dateStart || b.date || String(b.year || 0);
    return dir * aKey.localeCompare(bKey);
  });

  list.innerHTML = sorted.map((e, i) => `
    <div class="entry-card">
      <div class="entry-num">${sortOrder === 'desc' ? sorted.length - i : i + 1}</div>
      <div class="entry-info">
        <div class="entry-resort">${escHtml(e.resort || '')}</div>
        <div class="entry-meta">
          <span>ğŸ“… ${formatDateRange(e)}</span>
          ${e.note ? `<span>ğŸ’¬ ${escHtml(e.note)}</span>` : ''}
        </div>
      </div>
      <div>
        <div class="entry-days">${e.days}</div>
        <div class="entry-days-label">å¤©</div>
      </div>
      <button class="btn-delete" onclick="deleteEntry('${e.id}')" title="åˆªé™¤">âœ•</button>
    </div>
  `).join('');
}

function toggleSort() {
  sortOrder = sortOrder === 'desc' ? 'asc' : 'desc';
  document.getElementById('sortLabel').textContent = sortOrder === 'desc' ? 'æ–°åˆ°èˆŠ' : 'èˆŠåˆ°æ–°';
  document.getElementById('sortArrow').className = 'sort-arrow' + (sortOrder === 'asc' ? ' asc' : '');
  render();
}

function onDateChange() {
  const start = document.getElementById('inputDateStart').value;
  const end   = document.getElementById('inputDateEnd').value;
  if (start && end && end >= start)
    document.getElementById('inputDays').value = Math.round((new Date(end) - new Date(start)) / 86400000) + 1;
}

// â”€â”€ Actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function addEntry() {
  const dateStart = document.getElementById('inputDateStart').value;
  const dateEnd   = document.getElementById('inputDateEnd').value;
  const resort    = document.getElementById('inputResort').value.trim();
  const days      = parseInt(document.getElementById('inputDays').value);
  const note      = document.getElementById('inputNote').value.trim();

  let year;
  if (dateStart)    year = parseInt(dateStart.slice(0,4));
  else if (dateEnd) year = parseInt(dateEnd.slice(0,4));
  else { showToast('âš  è«‹è‡³å°‘å¡«å¯«é–‹å§‹æ—¥æœŸ'); return; }

  if (dateEnd && dateStart && dateEnd < dateStart) { showToast('âš  çµæŸæ—¥æœŸä¸èƒ½æ—©æ–¼é–‹å§‹æ—¥æœŸ'); return; }
  if (!resort)            { showToast('âš  è«‹è¼¸å…¥é›ªå ´åç¨±'); return; }
  if (!days || days < 1)  { showToast('âš  è«‹è¼¸å…¥å¤©æ•¸ï¼ˆè‡³å°‘ 1 å¤©ï¼‰'); return; }

  const btn = document.getElementById('btnAdd');
  btn.disabled = true; btn.textContent = 'å„²å­˜ä¸­â€¦';
  setSyncStatus('syncing', 'å„²å­˜ä¸­â€¦');

  try {
    await window._fbAdd({ year, dateStart, dateEnd, resort, days, note });
    showToast('âœ“ å·²æ–°å¢ï¼š' + resort + ' ' + days + ' å¤©');
    ['inputDateStart','inputDateEnd','inputResort','inputDays','inputNote'].forEach(id => {
      document.getElementById(id).value = '';
    });
  } catch(err) {
    showToast('âš  å„²å­˜å¤±æ•—ï¼š' + err.message);
    setSyncStatus('error', 'å„²å­˜å¤±æ•—');
  }
  btn.disabled = false; btn.textContent = 'åŠ å…¥ç´€éŒ„';
}

async function deleteEntry(id) {
  if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†ç´€éŒ„ï¼Ÿ')) return;
  setSyncStatus('syncing', 'åˆªé™¤ä¸­â€¦');
  try {
    await window._fbDelete(id);
    showToast('å·²åˆªé™¤ç´€éŒ„');
  } catch(err) {
    showToast('âš  åˆªé™¤å¤±æ•—ï¼š' + err.message);
    setSyncStatus('error', 'åˆªé™¤å¤±æ•—');
  }
}

async function clearAll() {
  if (!confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰ç´€éŒ„ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚')) return;
  setSyncStatus('syncing', 'æ¸…é™¤ä¸­â€¦');
  try {
    await window._fbClearAll();
    showToast('å·²æ¸…é™¤æ‰€æœ‰ç´€éŒ„');
  } catch(err) {
    showToast('âš  æ¸…é™¤å¤±æ•—ï¼š' + err.message);
    setSyncStatus('error', 'æ¸…é™¤å¤±æ•—');
  }
}

document.addEventListener('keydown', e => {
  const ids = ['inputDateStart','inputDateEnd','inputResort','inputDays','inputNote'];
  if (e.key === 'Enter' && ids.includes(e.target.id)) addEntry();
});
</script>
</body>
</html>
